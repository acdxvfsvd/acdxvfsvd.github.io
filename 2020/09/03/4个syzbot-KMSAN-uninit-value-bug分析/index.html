<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>4个syzbot KMSAN uninit-value bug分析 | acdxvfsvd&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="KMSAN: uninit-value in joydev_connecthttps:&#x2F;&#x2F;syzkaller.appspot.com&#x2F;bug?id&#x3D;b45de5d106f4c8795118d0c98e7bd572b9ad30a7 Linux Kernel 5.8.0-rc5 Log123456789101112131415161718192021222324252627usb 1-1: confi">
<meta property="og:type" content="article">
<meta property="og:title" content="4个syzbot KMSAN uninit-value bug分析">
<meta property="og:url" content="http://acdxvfsvd.github.io/2020/09/03/4%E4%B8%AAsyzbot-KMSAN-uninit-value-bug%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="acdxvfsvd&#39;s blog">
<meta property="og:description" content="KMSAN: uninit-value in joydev_connecthttps:&#x2F;&#x2F;syzkaller.appspot.com&#x2F;bug?id&#x3D;b45de5d106f4c8795118d0c98e7bd572b9ad30a7 Linux Kernel 5.8.0-rc5 Log123456789101112131415161718192021222324252627usb 1-1: confi">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-09-03T07:37:57.000Z">
<meta property="article:modified_time" content="2020-09-03T07:38:12.898Z">
<meta property="article:author" content="acdxvfsvd">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="acdxvfsvd&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">acdxvfsvd&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://acdxvfsvd.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-4个syzbot-KMSAN-uninit-value-bug分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/03/4%E4%B8%AAsyzbot-KMSAN-uninit-value-bug%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2020-09-03T07:37:57.000Z" itemprop="datePublished">2020-09-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      4个syzbot KMSAN uninit-value bug分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="KMSAN-uninit-value-in-joydev-connect"><a href="#KMSAN-uninit-value-in-joydev-connect" class="headerlink" title="KMSAN: uninit-value in joydev_connect"></a><strong>KMSAN: uninit-value in joydev_connect</strong></h1><p><code>https://syzkaller.appspot.com/bug?id=b45de5d106f4c8795118d0c98e7bd572b9ad30a7</code></p>
<p>Linux Kernel 5.8.0-rc5</p>
<h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">usb 1-1: config 0 interface 219 altsetting 0 endpoint 0xA has invalid wMaxPacketSize 0</span><br><span class="line">usb 1-1: New USB device found, idVendor&#x3D;078c, idProduct&#x3D;1002, bcdDevice&#x3D;e6.47</span><br><span class="line">usb 1-1: New USB device strings: Mfr&#x3D;0, Product&#x3D;0, SerialNumber&#x3D;0</span><br><span class="line">usb 1-1: config 0 descriptor??</span><br><span class="line">gtco 1-1:0.219: Collection level already at zero</span><br><span class="line">input: GTCO_CalComp as &#x2F;devices&#x2F;platform&#x2F;dummy_hcd.0&#x2F;usb1&#x2F;1-1&#x2F;1-1:0.219&#x2F;input&#x2F;input5</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">BUG: KMSAN: uninit-value in joydev_connect+0x10c0&#x2F;0x1920 drivers&#x2F;input&#x2F;joydev.c:958</span><br><span class="line">CPU: 1 PID: 27 Comm: kworker&#x2F;1:1 Not tainted 5.8.0-rc5-syzkaller #0</span><br><span class="line">Hardware name: Google Google Compute Engine&#x2F;Google Compute Engine, BIOS Google 01&#x2F;01&#x2F;2011</span><br><span class="line">Workqueue: usb_hub_wq hub_event</span><br><span class="line">Call Trace:</span><br><span class="line"> __dump_stack lib&#x2F;dump_stack.c:77 [inline]</span><br><span class="line"> dump_stack+0x21c&#x2F;0x280 lib&#x2F;dump_stack.c:118</span><br><span class="line"> kmsan_report+0xf7&#x2F;0x1e0 mm&#x2F;kmsan&#x2F;kmsan_report.c:121</span><br><span class="line"> __msan_warning+0x58&#x2F;0xa0 mm&#x2F;kmsan&#x2F;kmsan_instr.c:215</span><br><span class="line"> joydev_connect+0x10c0&#x2F;0x1920 drivers&#x2F;input&#x2F;joydev.c:958</span><br><span class="line"> input_attach_handler drivers&#x2F;input&#x2F;input.c:1031 [inline]</span><br><span class="line"> input_register_device+0x1d7b&#x2F;0x21c0 drivers&#x2F;input&#x2F;input.c:2229</span><br><span class="line"> gtco_probe+0x32ce&#x2F;0x39b0 drivers&#x2F;input&#x2F;tablet&#x2F;gtco.c:990</span><br><span class="line"> usb_probe_interface+0xece&#x2F;0x1550 drivers&#x2F;usb&#x2F;core&#x2F;driver.c:374</span><br><span class="line"> really_probe+0xf20&#x2F;0x20b0 drivers&#x2F;base&#x2F;dd.c:529</span><br><span class="line"> driver_probe_device+0x293&#x2F;0x390 drivers&#x2F;base&#x2F;dd.c:701</span><br><span class="line"> __device_attach_driver+0x63f&#x2F;0x830 drivers&#x2F;base&#x2F;dd.c:807</span><br><span class="line"> bus_for_each_drv+0x2ca&#x2F;0x3f0 drivers&#x2F;base&#x2F;bus.c:431</span><br><span class="line"> __device_attach+0x4e2&#x2F;0x7f0 drivers&#x2F;base&#x2F;dd.c:873</span><br><span class="line"> devic</span><br></pre></td></tr></table></figure>

<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>未初始化变量在<code>drivers/input/tablet/gtco.c</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__u32 globalval[TAG_GLOB_MAX];</span><br><span class="line">__u32 oldval[TAG_GLOB_MAX];</span><br></pre></td></tr></table></figure>

<p><code>TAG_GLOB_MAX</code>是12</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_USAGE        0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_LOG_MIN      1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_LOG_MAX      2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_PHYS_MIN     3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_PHYS_MAX     4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_UNIT_EXP     5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_UNIT         6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_REPORT_SZ    7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_REPORT_ID    8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_REPORT_CNT   9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_PUSH         10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_POP          11</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG_GLOB_MAX          12</span></span><br></pre></td></tr></table></figure>

<p>这……global var完全没初始化啊，怎么这样写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (device-&gt;max_X &#x3D;&#x3D; 0) &#123;</span><br><span class="line">	device-&gt;max_X &#x3D; globalval[TAG_GLOB_LOG_MAX];</span><br><span class="line">	device-&gt;min_X &#x3D; globalval[TAG_GLOB_LOG_MIN];</span><br><span class="line">&#125;</span><br><span class="line">break;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input_set_abs_params(inputdev, ABS_X, device-&gt;min_X, device-&gt;max_X, 0, 0);</span><br></pre></td></tr></table></figure>

<p>程序走的分支是根据参数中的report决定的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (i &lt; length) &#123;</span><br><span class="line">		prefix = report[i++];</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Determine data size and save the data in the proper variable */</span></span><br><span class="line">		<span class="built_in">size</span> = (<span class="number">1U</span> &lt;&lt; PREF_SIZE(prefix)) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span> (i + <span class="built_in">size</span> &gt; length) &#123;</span><br><span class="line">			dev_err(ddev,</span><br><span class="line">				<span class="string">&quot;Not enough data (need %d, have %d)\n&quot;</span>,</span><br><span class="line">				i + <span class="built_in">size</span>, length);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (<span class="built_in">size</span>) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			data = report[i];</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			data16 = get_unaligned_le16(&amp;report[i]);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">			data32 = get_unaligned_le32(&amp;report[i]);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Skip size of data */</span></span><br><span class="line">		i += <span class="built_in">size</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* What we do depends on the tag type */</span></span><br><span class="line">		tag  = PREF_TAG(prefix);</span><br><span class="line">		type = PREF_TYPE(prefix);</span><br><span class="line">		<span class="keyword">switch</span> (type) &#123;</span><br></pre></td></tr></table></figure>



<p>但是这个report并不是固定的，可控</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> TYPE_GLOBAL:</span><br><span class="line">			<span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>然而并不能保证一定先调用这个分支，导致了未初始化</p>
<p>范围是栈上一个12*int数组</p>
<p>数据带不回用户态，也不能作为指针，只能产生逻辑错误</p>
<h1 id="KMSAN-uninit-value-in-video-usercopy"><a href="#KMSAN-uninit-value-in-video-usercopy" class="headerlink" title="KMSAN: uninit-value in video_usercopy"></a><strong>KMSAN: uninit-value in video_usercopy</strong></h1><p><code>https://syzkaller.appspot.com/bug?id=46f76391fe0b58c2cc790c8e6f82bdf5b41d0354</code></p>
<p>Linux  Kernel 5.8.0-rc5</p>
<h2 id="Log-1"><a href="#Log-1" class="headerlink" title="Log"></a>Log</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">BUG: KMSAN: uninit-value in kmsan_check_memory+0xd&#x2F;0x10 mm&#x2F;kmsan&#x2F;kmsan_hooks.c:428</span><br><span class="line">CPU: 0 PID: 8471 Comm: syz-executor794 Not tainted 5.8.0-rc5-syzkaller #0</span><br><span class="line">Hardware name: Google Google Compute Engine&#x2F;Google Compute Engine, BIOS Google 01&#x2F;01&#x2F;2011</span><br><span class="line">Call Trace:</span><br><span class="line"> __dump_stack lib&#x2F;dump_stack.c:77 [inline]</span><br><span class="line"> dump_stack+0x1df&#x2F;0x240 lib&#x2F;dump_stack.c:118</span><br><span class="line"> kmsan_report+0xf7&#x2F;0x1e0 mm&#x2F;kmsan&#x2F;kmsan_report.c:121</span><br><span class="line"> kmsan_internal_check_memory+0x238&#x2F;0x3d0 mm&#x2F;kmsan&#x2F;kmsan.c:423</span><br><span class="line"> kmsan_check_memory+0xd&#x2F;0x10 mm&#x2F;kmsan&#x2F;kmsan_hooks.c:428</span><br><span class="line"> instrument_copy_to_user include&#x2F;linux&#x2F;instrumented.h:91 [inline]</span><br><span class="line"> _copy_to_user+0x100&#x2F;0x1d0 lib&#x2F;usercopy.c:30</span><br><span class="line"> copy_to_user include&#x2F;linux&#x2F;uaccess.h:161 [inline]</span><br><span class="line"> video_put_user drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-ioctl.c:3226 [inline]</span><br><span class="line"> video_usercopy+0x248a&#x2F;0x2c00 drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-ioctl.c:3325</span><br><span class="line"> video_ioctl2+0x9f&#x2F;0xb0 drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-ioctl.c:3335</span><br><span class="line"> v4l2_ioctl+0x23f&#x2F;0x270 drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-dev.c:360</span><br><span class="line"> vfs_ioctl fs&#x2F;ioctl.c:48 [inline]</span><br><span class="line"> ksys_ioctl fs&#x2F;ioctl.c:753 [inline]</span><br><span class="line"> __do_sys_ioctl fs&#x2F;ioctl.c:762 [inline]</span><br><span class="line"> __se_sys_ioctl+0x2e9&#x2F;0x410 fs&#x2F;ioctl.c:760</span><br><span class="line"> __x64_sys_ioctl+0x4a&#x2F;0x70 fs&#x2F;ioctl.c:760</span><br><span class="line"> do_syscall_64+0xb0&#x2F;0x150 arch&#x2F;x86&#x2F;entry&#x2F;common.c:386</span><br><span class="line"> entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">RIP: 0033:0x444009</span><br><span class="line">Code: Bad RIP value.</span><br><span class="line">RSP: 002b:00007ffd83706aa8 EFLAGS: 00000246 ORIG_RAX: 0000000000000010</span><br><span class="line">RAX: ffffffffffffffda RBX: 00000000004002e0 RCX: 0000000000444009</span><br><span class="line">RDX: 0000000020000100 RSI: 00000000c0505611 RDI: 0000000000000003</span><br><span class="line">RBP: 00000000006ce018 R08: 00000000004002e0 R09: 00000000004002e0</span><br><span class="line">R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000401c90</span><br><span class="line">R13: 0000000000401d20 R14: 0000000000000000 R15: 0000000000000000</span><br><span class="line"></span><br><span class="line">Local variable ----vb32.i@video_usercopy created at:</span><br><span class="line"> video_put_user drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-ioctl.c:3210 [inline]</span><br><span class="line"> video_usercopy+0x20bd&#x2F;0x2c00 drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-ioctl.c:3325</span><br><span class="line"> video_put_user drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-ioctl.c:3210 [inline]</span><br><span class="line"> video_usercopy+0x20bd&#x2F;0x2c00 drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-ioctl.c:3325</span><br><span class="line"></span><br><span class="line">Bytes 52-55 of 80 are uninitialized</span><br><span class="line">Memory access of size 80 starts at ffffa41d80dcfce0</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><p><code>drivers/media/v4l2-core/v4l2-ioctl.c</code> line 3210-</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_buffer</span> *<span class="title">vb</span> = <span class="title">parg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">v4l2_buffer_time32</span> <span class="title">vb32</span> = &#123;</span></span><br><span class="line">		.index		= vb-&gt;index,</span><br><span class="line">		.type		= vb-&gt;type,</span><br><span class="line">		.bytesused	= vb-&gt;bytesused,</span><br><span class="line">		.flags		= vb-&gt;flags,</span><br><span class="line">		.field		= vb-&gt;field,</span><br><span class="line">		.timestamp.tv_sec	= vb-&gt;timestamp.tv_sec,</span><br><span class="line">		.timestamp.tv_usec	= vb-&gt;timestamp.tv_usec,</span><br><span class="line">		.timecode	= vb-&gt;timecode,</span><br><span class="line">		.sequence	= vb-&gt;sequence,</span><br><span class="line">		.memory		= vb-&gt;memory,</span><br><span class="line">		.m.userptr	= vb-&gt;m.userptr,</span><br><span class="line">		.length		= vb-&gt;length,</span><br><span class="line">		.request_fd	= vb-&gt;request_fd,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(arg, &amp;vb32, <span class="keyword">sizeof</span>(vb32)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>结构体定义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_buffer_time32</span> &#123;</span></span><br><span class="line">	__u32			index;</span><br><span class="line">	__u32			type;</span><br><span class="line">	__u32			bytesused;</span><br><span class="line">	__u32			flags;</span><br><span class="line">	__u32			field;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">old_timeval32</span>	<span class="title">timestamp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">v4l2_timecode</span>	<span class="title">timecode</span>;</span></span><br><span class="line">	__u32			sequence;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* memory location */</span></span><br><span class="line">	__u32			memory;</span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		__u32           offset;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span>   userptr;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">v4l2_plane</span> *<span class="title">planes</span>;</span></span><br><span class="line">		__s32		fd;</span><br><span class="line">	&#125; m;</span><br><span class="line">	__u32			length;</span><br><span class="line">	__u32			reserved2;</span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		__s32		request_fd;</span><br><span class="line">		__u32		reserved;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>编译之后的内存布局</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> v4l2_buffer_time32 struc ; (<span class="keyword">sizeof</span>=<span class="number">0x50</span>, align=<span class="number">0x8</span>, copyof_152)</span><br><span class="line"><span class="number">00000000</span> index           dd ?</span><br><span class="line"><span class="number">00000004</span> type            dd ?</span><br><span class="line"><span class="number">00000008</span> bytesused       dd ?</span><br><span class="line"><span class="number">0000000</span>C flags           dd ?</span><br><span class="line"><span class="number">00000010</span> field           dd ?</span><br><span class="line"><span class="number">00000014</span> timestamp       old_timeval32 ?</span><br><span class="line"><span class="number">0000001</span>C timecode        v4l2_timecode ?</span><br><span class="line"><span class="number">0000002</span>C sequence        dd ?</span><br><span class="line"><span class="number">00000030</span> memory          dd ?</span><br><span class="line"><span class="number">00000034</span>                 db ? ; undefined</span><br><span class="line"><span class="number">00000035</span>                 db ? ; undefined</span><br><span class="line"><span class="number">00000036</span>                 db ? ; undefined</span><br><span class="line"><span class="number">00000037</span>                 db ? ; undefined</span><br><span class="line"><span class="number">00000038</span> m               v4l2_buffer_time32::$F88FECCE053155685B8E90846FFE160D ?</span><br><span class="line"><span class="number">00000040</span> length          dd ?</span><br><span class="line"><span class="number">00000044</span> reserved2       dd ?</span><br><span class="line"><span class="number">00000048</span> anonymous_0     v4l2_buffer_time32::$<span class="number">568</span>C605C3BC64B6FBDCB8F8D0FEB1B37 ?</span><br><span class="line"><span class="number">0000004</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">0000004</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">0000004</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">0000004F</span>                 db ? ; undefined</span><br></pre></td></tr></table></figure>

<p>结构体在kernel stack上，x86与x86-64均crash</p>
<p>未初始化的有3个地方</p>
<ul>
<li><p>由于内存对齐的原因，存在空洞内存，没有初始化 </p>
</li>
<li><p>代码里reserved2成员没有初始化</p>
</li>
<li><p>这边m是个union类型，里面除了一个planes指针以外其他的成员都是32bit</p>
<p>在64位系统下，指针是8byte，所以这个union占8bytes</p>
<p>初始化的时候对这个union初始化选择的是userptr这个成员，长度为4个字节，导致有4个字节没有初始化</p>
</li>
</ul>
<p>后面只有一个copy to user，只能leak</p>
<p>查看Syscall中变量是否被覆盖，发现触发了中断碰到了变量，待进一步调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line"></span><br><span class="line">Thread 1 hit Hardware watchpoint 11: *0xffffc9000020be08</span><br><span class="line"></span><br><span class="line">Old value &#x3D; 2145817</span><br><span class="line">New value &#x3D; -1068476911</span><br><span class="line">0xffffffff84000f51 in error_entry () at arch&#x2F;x86&#x2F;entry&#x2F;entry_64.S:873</span><br><span class="line">873             PUSH_AND_CLEAR_REGS save_ret&#x3D;1</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">───────────────────────────────────────────────────────────────────────[ REGISTERS ]────────────────────────────────────────────────────────────────────────</span><br><span class="line">*RAX  0xffffffff82dca52a (v4l2_ioctl+106) ◂— mov    rdi, r12 &#x2F;* 0x894cfe8944e7894c *&#x2F;</span><br><span class="line">*RBX  0xffffffff82dcb980 ◂— push   rbp &#x2F;* 0x56415741e5894855 *&#x2F;</span><br><span class="line"> RCX  0xffff888130588f00 ◂— 0</span><br><span class="line">*RDX  0x0</span><br><span class="line"> RDI  0xffff8881397ad700 ◂— 0</span><br><span class="line">*RSI  0xffffffff84000bfa (asm_sysvec_apic_timer_interrupt+10) ◂— mov    rdi, rsp &#x2F;* 0xffe89d6ee8e78948 *&#x2F;</span><br><span class="line"> R8   0x0</span><br><span class="line"> R9   0x0</span><br><span class="line"> R10  0x0</span><br><span class="line"> R11  0xffffffff82dca4c0 (v4l2_ioctl) ◂— push   rbp &#x2F;* 0x56415741e5894855 *&#x2F;</span><br><span class="line"> R12  0xffff8881397ad700 ◂— 0</span><br><span class="line"> R13  0xc0505611</span><br><span class="line"> R14  0x20000100 ◂— add    byte ptr [rax], al &#x2F;* 0x900000000 *&#x2F;</span><br><span class="line"> R15  0xc0505611</span><br><span class="line">*RBP  0xffffc9000020beb0 —▸ 0xffffc9000020bee0 —▸ 0xffffc9000020bf18 —▸ 0xffffc9000020bf30 —▸ 0xffffc9000020bf48 ◂— ...</span><br><span class="line">*RSP  0xffffc9000020be08 ◂— adc    dword ptr [rsi + 0x50], edx &#x2F;* 0xc0505611 *&#x2F;</span><br><span class="line">*RIP  0xffffffff84000f51 (error_entry+33) ◂— push   rsi &#x2F;* 0xc03145c931d23156 *&#x2F;</span><br><span class="line">─────────────────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0xffffffff84000f51 &lt;error_entry+33&gt;    push   rsi &lt;0xffffffff84000bfa&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0xffffffff84000f54 &lt;error_entry+36&gt;    xor    ecx, ecx</span><br><span class="line">   0xffffffff84000f56 &lt;error_entry+38&gt;    xor    r8d, r8d</span><br><span class="line">   0xffffffff84000f59 &lt;error_entry+41&gt;    xor    r9d, r9d</span><br><span class="line">   0xffffffff84000f5c &lt;error_entry+44&gt;    xor    r10d, r10d</span><br><span class="line">   0xffffffff84000f5f &lt;error_entry+47&gt;    xor    r11d, r11d</span><br><span class="line">   0xffffffff84000f62 &lt;error_entry+50&gt;    xor    ebx, ebx</span><br><span class="line">   0xffffffff84000f64 &lt;error_entry+52&gt;    xor    ebp, ebp</span><br><span class="line">   0xffffffff84000f66 &lt;error_entry+54&gt;    xor    r12d, r12d</span><br><span class="line">   0xffffffff84000f69 &lt;error_entry+57&gt;    xor    r13d, r13d</span><br><span class="line">   0xffffffff84000f6c &lt;error_entry+60&gt;    xor    r14d, r14d</span><br><span class="line">─────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]──────────────────────────────────────────────────────────────────────</span><br><span class="line">In file: &#x2F;home&#x2F;acdxvfsvd&#x2F;linux-5.8-rc5&#x2F;arch&#x2F;x86&#x2F;entry&#x2F;entry_64.S</span><br><span class="line">   868  * Save all registers in pt_regs, and switch GS if needed.</span><br><span class="line">   869  *&#x2F;</span><br><span class="line">   870 SYM_CODE_START_LOCAL(error_entry)</span><br><span class="line">   871  UNWIND_HINT_FUNC</span><br><span class="line">   872  cld</span><br><span class="line"> ► 873  PUSH_AND_CLEAR_REGS save_ret&#x3D;1</span><br><span class="line">   874  ENCODE_FRAME_POINTER 8</span><br><span class="line">   875  testb   $3, CS+8(%rsp)</span><br><span class="line">   876  jz      .Lerror_kernelspace</span><br><span class="line">   877</span><br><span class="line">   878  &#x2F;*</span><br><span class="line">─────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0xffffc9000020be08 ◂— adc    dword ptr [rsi + 0x50], edx &#x2F;* 0xc0505611 *&#x2F;</span><br><span class="line">01:0008│      0xffffc9000020be10 —▸ 0x20000100 ◂— add    byte ptr [rax], al &#x2F;* 0x900000000 *&#x2F;</span><br><span class="line">02:0010│      0xffffc9000020be18 ◂— adc    dword ptr [rsi + 0x50], edx &#x2F;* 0xc0505611 *&#x2F;</span><br><span class="line">03:0018│      0xffffc9000020be20 —▸ 0xffff8881397ad700 ◂— 0</span><br><span class="line">04:0020│      0xffffc9000020be28 —▸ 0xffffc9000020beb0 —▸ 0xffffc9000020bee0 —▸ 0xffffc9000020bf18 —▸ 0xffffc9000020bf30 ◂— ...</span><br><span class="line">05:0028│      0xffffc9000020be30 —▸ 0xffffffff82dcb980 ◂— push   rbp &#x2F;* 0x56415741e5894855 *&#x2F;</span><br><span class="line">06:0030│      0xffffc9000020be38 —▸ 0xffffffff82dca4c0 (v4l2_ioctl) ◂— push   rbp &#x2F;* 0x56415741e5894855 *&#x2F;</span><br><span class="line">07:0038│      0xffffc9000020be40 ◂— 0</span><br><span class="line">───────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0 ffffffff84000f51 error_entry+33</span><br><span class="line">   f 1         c0505611</span><br><span class="line">   f 2         20000100</span><br><span class="line">   f 3         c0505611</span><br><span class="line">   f 4 ffff8881397ad700</span><br><span class="line">   f 5 ffffc9000020beb0</span><br><span class="line">   f 6 ffffffff82dcb980</span><br><span class="line">   f 7 ffffffff82dca52a v4l2_ioctl+106</span><br><span class="line">   f 8 ffffffff8141d1e0 __se_sys_ioctl+160</span><br><span class="line">   f 9 ffffffff8141d1e0 __se_sys_ioctl+160</span><br><span class="line">   f 10 ffffffff8141d1e0 __se_sys_ioctl+160</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line"></span><br><span class="line">Thread 1 hit Breakpoint 1, video_put_user (arg&#x3D;0x20000100, parg&#x3D;0xffffc9000020bd50, cmd&#x3D;3226490385) at drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-ioctl.c:3211</span><br><span class="line">3211                            .index          &#x3D; vb-&gt;index,</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">───────────────────────────────────────────────────────────────────────[ REGISTERS ]────────────────────────────────────────────────────────────────────────</span><br><span class="line">*RAX  0xffffffff82dcb4e6 ◂— mov    eax, dword ptr [r12] &#x2F;* 0xd024848924048b41 *&#x2F;</span><br><span class="line">*RBX  0x40</span><br><span class="line"> RCX  0xffff888130588f00 ◂— 8</span><br><span class="line"> RDX  0x0</span><br><span class="line">*RDI  0xffff88813aa0fbc0 ◂— and    byte ptr [rdi + rsi*2 + 0x1eced17b], 0xa1 &#x2F;* 0xa11eced17b77a480 *&#x2F;</span><br><span class="line">*RSI  0x0</span><br><span class="line">*R8   0xffff88813bc2d9f0 —▸ 0xffff88813aa0fb40 ◂— adc    al, byte ptr [rbx] &#x2F;* 0x502d3682b3e50312 *&#x2F;</span><br><span class="line">*R9   0xffff88813aa0fb80 ◂— 0</span><br><span class="line">*R10  0xffff88813aa0fb80 ◂— 0</span><br><span class="line">*R11  0xffff88813b0036c0 ◂— 0x2d9f0</span><br><span class="line">*R12  0xffffc9000020bd50 ◂— add    byte ptr [rax], al &#x2F;* 0x900000000 *&#x2F;</span><br><span class="line">*R13  0xfffffffffffffff2</span><br><span class="line">*R14  0xffff88813aa0fb80 ◂— 0</span><br><span class="line"> R15  0xc0505611</span><br><span class="line">*RBP  0xffffc9000020be88 —▸ 0xffffc9000020beb0 —▸ 0xffffc9000020bee0 —▸ 0xffffc9000020bf18 —▸ 0xffffc9000020bf30 ◂— ...</span><br><span class="line">*RSP  0xffffc9000020bd00 —▸ 0xffff8881393b21d0 ◂— mov    al, 0x21 &#x2F;* 0xd21b0 *&#x2F;</span><br><span class="line">*RIP  0xffffffff82dcb4e6 ◂— mov    eax, dword ptr [r12] &#x2F;* 0xd024848924048b41 *&#x2F;</span><br><span class="line">─────────────────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0xffffffff82dcb4e6                          mov    eax, dword ptr [r12]</span><br><span class="line">   0xffffffff82dcb4ea &lt;video_usercopy+1866&gt;    mov    dword ptr [rsp + 0xd0], eax</span><br><span class="line">   0xffffffff82dcb4f1                          mov    eax, dword ptr [r12 + 4]</span><br><span class="line">   0xffffffff82dcb4f6                          mov    dword ptr [rsp + 0xd4], eax</span><br><span class="line">   0xffffffff82dcb4fd                          mov    eax, dword ptr [r12 + 8]</span><br><span class="line">   0xffffffff82dcb502                          mov    dword ptr [rsp + 0xd8], eax</span><br><span class="line">   0xffffffff82dcb509                          mov    eax, dword ptr [r12 + 0xc]</span><br><span class="line">   0xffffffff82dcb50e                          mov    dword ptr [rsp + 0xdc], eax</span><br><span class="line">   0xffffffff82dcb515                          mov    eax, dword ptr [r12 + 0x10]</span><br><span class="line">   0xffffffff82dcb51a                          mov    dword ptr [rsp + 0xe0], eax</span><br><span class="line">   0xffffffff82dcb521                          mov    eax, dword ptr [r12 + 0x18]</span><br><span class="line">─────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]──────────────────────────────────────────────────────────────────────</span><br><span class="line">In file: &#x2F;home&#x2F;acdxvfsvd&#x2F;linux-5.8-rc5&#x2F;drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-ioctl.c</span><br><span class="line">   3206         case VIDIOC_QBUF_TIME32:</span><br><span class="line">   3207         case VIDIOC_DQBUF_TIME32:</span><br><span class="line">   3208         case VIDIOC_PREPARE_BUF_TIME32: &#123;</span><br><span class="line">   3209                 struct v4l2_buffer *vb &#x3D; parg;</span><br><span class="line">   3210                 struct v4l2_buffer_time32 vb32 &#x3D; &#123;</span><br><span class="line"> ► 3211                         .index          &#x3D; vb-&gt;index,</span><br><span class="line">   3212                         .type           &#x3D; vb-&gt;type,</span><br><span class="line">   3213                         .bytesused      &#x3D; vb-&gt;bytesused,</span><br><span class="line">   3214                         .flags          &#x3D; vb-&gt;flags,</span><br><span class="line">   3215                         .field          &#x3D; vb-&gt;field,</span><br><span class="line">   3216                         .timestamp.tv_sec       &#x3D; vb-&gt;timestamp.tv_sec,</span><br><span class="line">─────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0xffffc9000020bd00 —▸ 0xffff8881393b21d0 ◂— mov    al, 0x21 &#x2F;* 0xd21b0 *&#x2F;</span><br><span class="line">01:0008│      0xffffc9000020bd08 ◂— xchg   byte ptr [rdx], sil &#x2F;* 0x28132864a *&#x2F;</span><br><span class="line">02:0010│      0xffffc9000020bd10 ◂— 0</span><br><span class="line">... ↓</span><br><span class="line">04:0020│      0xffffc9000020bd20 —▸ 0xffffc9000020bd90 ◂— 0</span><br><span class="line">05:0028│      0xffffc9000020bd28 —▸ 0xffff8881397ad700 ◂— 0</span><br><span class="line">06:0030│      0xffffc9000020bd30 —▸ 0xffffc9000020be98 —▸ 0xffffffff82dcb980 ◂— push   rbp &#x2F;* 0x56415741e5894855 *&#x2F;</span><br><span class="line">07:0038│      0xffffc9000020bd38 ◂— 0</span><br><span class="line">───────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0 ffffffff82dcb4e6</span><br><span class="line">   f 1 ffffffff82dcb4e6</span><br><span class="line">   f 2 ffffffff82dcb9ac video_ioctl2+44</span><br><span class="line">   f 3 ffffffff82dca53b v4l2_ioctl+123</span><br><span class="line">   f 4 ffffffff8141d1e0 __se_sys_ioctl+160</span><br><span class="line">   f 5 ffffffff8141d1e0 __se_sys_ioctl+160</span><br><span class="line">   f 6 ffffffff8141d1e0 __se_sys_ioctl+160</span><br><span class="line">   f 7 ffffffff8141d1e0 __se_sys_ioctl+160</span><br><span class="line">   f 8 ffffffff8141d12e __x64_sys_ioctl+30</span><br><span class="line">   f 9 ffffffff83e875ec do_syscall_64+76</span><br><span class="line">   f 10 ffffffff84000068 entry_SYSCALL_64+104</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; p &amp;vb32.m</span><br><span class="line">$22 &#x3D; (union &#123;...&#125; *) 0xffffc9000020be08</span><br><span class="line">pwndbg&gt; i b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep y   0xffffffff82dcb4e6 in video_usercopy at drivers&#x2F;media&#x2F;v4l2-core&#x2F;v4l2-ioctl.c:3211</span><br><span class="line">        breakpoint already hit 19 times</span><br><span class="line">7       breakpoint     keep y   &lt;PENDING&gt;          *main</span><br><span class="line">11      hw watchpoint  keep y                      *0xffffc9000020be08</span><br><span class="line">        breakpoint already hit 2 times</span><br></pre></td></tr></table></figure>



<h1 id="KMSAN-uninit-value-in-copy-to-iter-3"><a href="#KMSAN-uninit-value-in-copy-to-iter-3" class="headerlink" title="KMSAN: uninit-value in _copy_to_iter (3)"></a><strong>KMSAN: uninit-value in _copy_to_iter (3)</strong></h1><p><code>https://syzkaller.appspot.com/bug?id=36fb96b6857e6ee6848ab34825a3f3ce33c84ed8</code></p>
<p>Linux 5.8.0-rc5</p>
<h2 id="Log-2"><a href="#Log-2" class="headerlink" title="Log"></a>Log</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">BUG: KMSAN: uninit-value in kmsan_check_memory+0xd&#x2F;0x10 mm&#x2F;kmsan&#x2F;kmsan_hooks.c:428</span><br><span class="line">CPU: 0 PID: 8682 Comm: syz-executor281 Not tainted 5.8.0-rc5-syzkaller #0</span><br><span class="line">Hardware name: Google Google Compute Engine&#x2F;Google Compute Engine, BIOS Google 01&#x2F;01&#x2F;2011</span><br><span class="line">Call Trace:</span><br><span class="line"> __dump_stack lib&#x2F;dump_stack.c:77 [inline]</span><br><span class="line"> dump_stack+0x1df&#x2F;0x240 lib&#x2F;dump_stack.c:118</span><br><span class="line"> kmsan_report+0xf7&#x2F;0x1e0 mm&#x2F;kmsan&#x2F;kmsan_report.c:121</span><br><span class="line"> kmsan_internal_check_memory+0x238&#x2F;0x3d0 mm&#x2F;kmsan&#x2F;kmsan.c:423</span><br><span class="line"> kmsan_check_memory+0xd&#x2F;0x10 mm&#x2F;kmsan&#x2F;kmsan_hooks.c:428</span><br><span class="line"> instrument_copy_to_user include&#x2F;linux&#x2F;instrumented.h:91 [inline]</span><br><span class="line"> copyout lib&#x2F;iov_iter.c:142 [inline]</span><br><span class="line"> _copy_to_iter+0x3d4&#x2F;0x26e0 lib&#x2F;iov_iter.c:631</span><br><span class="line"> copy_to_iter include&#x2F;linux&#x2F;uio.h:138 [inline]</span><br><span class="line"> memcpy_to_msg include&#x2F;linux&#x2F;skbuff.h:3571 [inline]</span><br><span class="line"> bcm_recvmsg+0x25a&#x2F;0x740 net&#x2F;can&#x2F;bcm.c:1612</span><br><span class="line"> sock_recvmsg_nosec net&#x2F;socket.c:886 [inline]</span><br><span class="line"> sock_recvmsg net&#x2F;socket.c:904 [inline]</span><br><span class="line"> __sys_recvfrom+0xacd&#x2F;0xae0 net&#x2F;socket.c:2052</span><br><span class="line"> __do_sys_recvfrom net&#x2F;socket.c:2070 [inline]</span><br><span class="line"> __se_sys_recvfrom+0x111&#x2F;0x130 net&#x2F;socket.c:2066</span><br><span class="line"> __x64_sys_recvfrom+0x6e&#x2F;0x90 net&#x2F;socket.c:2066</span><br><span class="line"> do_syscall_64+0xb0&#x2F;0x150 arch&#x2F;x86&#x2F;entry&#x2F;common.c:386</span><br><span class="line"> entry_SYSCALL_64_after_hwframe+0x44&#x2F;0xa9</span><br><span class="line">RIP: 0033:0x448cd9</span><br><span class="line">Code: Bad RIP value.</span><br><span class="line">RSP: 002b:00007f5fbb95fd88 EFLAGS: 00000246 ORIG_RAX: 000000000000002d</span><br><span class="line">RAX: ffffffffffffffda RBX: 00000000006dec68 RCX: 0000000000448cd9</span><br><span class="line">RDX: 0000000000000032 RSI: 0000000020000040 RDI: 0000000000000003</span><br><span class="line">RBP: 00000000006dec60 R08: 0000000000000000 R09: 0000000000000000</span><br><span class="line">R10: 0000000000000000 R11: 0000000000000246 R12: 00000000006dec6c</span><br><span class="line">R13: ffffff7f00000001 R14: 0000000000000000 R15: 000000306e616376</span><br><span class="line"></span><br><span class="line">Uninit was stored to memory at:</span><br><span class="line"> kmsan_save_stack_with_flags mm&#x2F;kmsan&#x2F;kmsan.c:144 [inline]</span><br><span class="line"> kmsan_internal_chain_origin+0xad&#x2F;0x130 mm&#x2F;kmsan&#x2F;kmsan.c:310</span><br><span class="line"> kmsan_memcpy_memmove_metadata+0x272&#x2F;0x2e0 mm&#x2F;kmsan&#x2F;kmsan.c:247</span><br><span class="line"> kmsan_memcpy_metadata+0xb&#x2F;0x10 mm&#x2F;kmsan&#x2F;kmsan.c:267</span><br><span class="line"> __msan_memcpy+0x43&#x2F;0x50 mm&#x2F;kmsan&#x2F;kmsan_instr.c:116</span><br><span class="line"> skb_put_data include&#x2F;linux&#x2F;skbuff.h:2260 [inline]</span><br><span class="line"> bcm_send_to_user+0x250&#x2F;0x820 net&#x2F;can&#x2F;bcm.c:327</span><br><span class="line"> bcm_tx_timeout_handler+0x5d0&#x2F;0x620 net&#x2F;can&#x2F;bcm.c:413</span><br><span class="line"> __run_hrtimer kernel&#x2F;time&#x2F;hrtimer.c:1520 [inline]</span><br><span class="line"> __hrtimer_run_queues+0xa61&#x2F;0x1340 kernel&#x2F;time&#x2F;hrtimer.c:1584</span><br><span class="line"> hrtimer_run_softirq+0x1b2&#x2F;0x2b0 kernel&#x2F;time&#x2F;hrtimer.c:1601</span><br><span class="line"> __do_softirq+0x311&#x2F;0x83d kernel&#x2F;softirq.c:293</span><br><span class="line"></span><br><span class="line">Local variable ----msg_head@bcm_tx_timeout_handler created at:</span><br><span class="line"> bcm_tx_timeout_handler+0x4f&#x2F;0x620 net&#x2F;can&#x2F;bcm.c:398</span><br><span class="line"> bcm_tx_timeout_handler+0x4f&#x2F;0x620 net&#x2F;can&#x2F;bcm.c:398</span><br><span class="line"></span><br><span class="line">Bytes 12-15 of 50 are uninitialized</span><br><span class="line">Memory access of size 50 starts at ffff88b629809600</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>



<h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><p>uninitialized use 的位置</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">enum</span> hrtimer_restart <span class="title">bcm_tx_timeout_handler</span><span class="params">(struct hrtimer *hrtimer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bcm_op</span> *<span class="title">op</span> = <span class="title">container_of</span>(<span class="title">hrtimer</span>, <span class="title">struct</span> <span class="title">bcm_op</span>, <span class="title">timer</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bcm_msg_head</span> <span class="title">msg_head</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (op-&gt;kt_ival1 &amp;&amp; (op-&gt;count &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">		op-&gt;count--;</span><br><span class="line">		<span class="keyword">if</span> (!op-&gt;count &amp;&amp; (op-&gt;flags &amp; TX_COUNTEVT)) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* create notification to user */</span></span><br><span class="line">			msg_head.opcode  = TX_EXPIRED;</span><br><span class="line">			msg_head.flags   = op-&gt;flags;</span><br><span class="line">			msg_head.count   = op-&gt;count;</span><br><span class="line">			msg_head.ival1   = op-&gt;ival1;</span><br><span class="line">			msg_head.ival2   = op-&gt;ival2;</span><br><span class="line">			msg_head.can_id  = op-&gt;can_id;</span><br><span class="line">			msg_head.nframes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			bcm_send_to_user(op, &amp;msg_head, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>结构体定义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bcm_timeval</span> &#123;</span></span><br><span class="line">	<span class="keyword">long</span> tv_sec;</span><br><span class="line">	<span class="keyword">long</span> tv_usec;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> __u32 <span class="keyword">canid_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">can_frame</span> &#123;</span></span><br><span class="line">	<span class="keyword">canid_t</span> can_id;  <span class="comment">/* 32 bit CAN_ID + EFF/RTR/ERR flags */</span></span><br><span class="line">	__u8    can_dlc; <span class="comment">/* frame payload length in byte (0 .. CAN_MAX_DLEN) */</span></span><br><span class="line">	__u8    __pad;   <span class="comment">/* padding */</span></span><br><span class="line">	__u8    __res0;  <span class="comment">/* reserved / padding */</span></span><br><span class="line">	__u8    __res1;  <span class="comment">/* reserved / padding */</span></span><br><span class="line">	__u8    data[CAN_MAX_DLEN] __attribute__((aligned(<span class="number">8</span>)));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bcm_msg_head</span> &#123;</span></span><br><span class="line">	__u32 opcode;</span><br><span class="line">	__u32 flags;</span><br><span class="line">	__u32 count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bcm_timeval</span> <span class="title">ival1</span>, <span class="title">ival2</span>;</span></span><br><span class="line">	<span class="keyword">canid_t</span> can_id;</span><br><span class="line">	__u32 nframes;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">can_frame</span> <span class="title">frames</span>[0];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>结构体在stack上</p>
<p>64bit下的内存布局</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">00000000 bcm_msg_head    struc ; (sizeof&#x3D;0x28, align&#x3D;0x8, copyof_156, variable size)</span><br><span class="line">00000000 opcode          dd ?</span><br><span class="line">00000004 flags           dd ?</span><br><span class="line">00000008 count           dd ?</span><br><span class="line">0000000C ival1           bcm_timeval ?</span><br><span class="line">00000014 ival2           bcm_timeval ?</span><br><span class="line">0000001C can_id          dd ?</span><br><span class="line">00000020 nframes         dd ?</span><br><span class="line">00000024                 db ? ; undefined</span><br><span class="line">00000025                 db ? ; undefined</span><br><span class="line">00000026                 db ? ; undefined</span><br><span class="line">00000027                 db ? ; undefined</span><br><span class="line">00000028 frames          can_frame 0 dup(?)</span><br><span class="line">00000028 bcm_msg_head    ends</span><br></pre></td></tr></table></figure>

<p>4bytes的memory hole</p>
<p>同一个repro还有另一种不同的crash情况</p>
<h2 id="Log-2"><a href="#Log-2" class="headerlink" title="Log#2"></a>Log#2</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[  <span class="number">106.298991</span>][ T4828] BUG: KMSAN: uninit-value in kmsan_check_memory+<span class="number">0xd</span>/<span class="number">0x10</span></span><br><span class="line">[  <span class="number">106.305644</span>][ T4828] CPU: <span class="number">0</span> PID: <span class="number">4828</span> Comm: <span class="built_in">exp</span><span class="number">-36f</span>b Tainted: G    B             <span class="number">5.8</span><span class="number">.0</span>-rc5+ #<span class="number">6</span></span><br><span class="line">[  106.313624][ T4828] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014</span><br><span class="line">[  <span class="number">106.322398</span>][ T4828] Call Trace:</span><br><span class="line">[  <span class="number">106.325443</span>][ T4828]  dump_stack+<span class="number">0x1df</span>/<span class="number">0x240</span></span><br><span class="line">[  <span class="number">106.329789</span>][ T4828]  kmsan_report+<span class="number">0xfb</span>/<span class="number">0x1e0</span></span><br><span class="line">[  <span class="number">106.334511</span>][ T4828]  kmsan_internal_check_memory+<span class="number">0x21d</span>/<span class="number">0x3b0</span></span><br><span class="line">[  <span class="number">106.339611</span>][ T4828]  ? unwind_get_return_address+<span class="number">0x80</span>/<span class="number">0x120</span></span><br><span class="line">[  <span class="number">106.344442</span>][ T4828]  kmsan_check_memory+<span class="number">0xd</span>/<span class="number">0x10</span></span><br><span class="line">[  <span class="number">106.348753</span>][ T4828]  _copy_to_iter+<span class="number">0xd2a</span>/<span class="number">0x27d0</span></span><br><span class="line">[  <span class="number">106.353649</span>][ T4828]  ? kmsan_get_metadata+<span class="number">0x4f</span>/<span class="number">0x180</span></span><br><span class="line">[  <span class="number">106.358228</span>][ T4828]  ? __skb_try_recv_from_queue+<span class="number">0x6ba</span>/<span class="number">0xdf0</span></span><br><span class="line">[  <span class="number">106.363156</span>][ T4828]  __skb_datagram_iter+<span class="number">0x298</span>/<span class="number">0x11b0</span></span><br><span class="line">[  <span class="number">106.367877</span>][ T4828]  ? __skb_try_recv_datagram+<span class="number">0x543</span>/<span class="number">0x690</span></span><br><span class="line">[  <span class="number">106.372925</span>][ T4828]  ? skb_copy_datagram_iter+<span class="number">0x2b0</span>/<span class="number">0x2b0</span></span><br><span class="line">[  <span class="number">106.378987</span>][ T4828]  skb_copy_datagram_iter+<span class="number">0x292</span>/<span class="number">0x2b0</span></span><br><span class="line">[  <span class="number">106.383837</span>][ T4828]  packet_recvmsg+<span class="number">0x63f</span>/<span class="number">0x1c30</span></span><br><span class="line">[  <span class="number">106.388105</span>][ T4828]  ? kmsan_internal_unpoison_shadow+<span class="number">0x42</span>/<span class="number">0x70</span></span><br><span class="line">[  <span class="number">106.395590</span>][ T4828]  ? packet_sendmsg+<span class="number">0x8850</span>/<span class="number">0x8850</span></span><br><span class="line">[  <span class="number">106.400814</span>][ T4828]  ____sys_recvmsg+<span class="number">0xee5</span>/<span class="number">0xfa0</span></span><br><span class="line">[  <span class="number">106.404773</span>][ T4828]  ? kmsan_get_metadata+<span class="number">0x4f</span>/<span class="number">0x180</span></span><br><span class="line">[  <span class="number">106.409263</span>][ T4828]  do_recvmmsg+<span class="number">0x89c</span>/<span class="number">0x1ed0</span></span><br><span class="line">[  <span class="number">106.413853</span>][ T4828]  ? blkcg_maybe_throttle_current+<span class="number">0x181</span>/<span class="number">0x1400</span></span><br><span class="line">[  <span class="number">106.419706</span>][ T4828]  ? __msan_poison_alloca+<span class="number">0xf0</span>/<span class="number">0x120</span></span><br><span class="line">[  <span class="number">106.424239</span>][ T4828]  ? __se_sys_recvmmsg+<span class="number">0xac</span>/<span class="number">0x350</span></span><br><span class="line">[  <span class="number">106.428721</span>][ T4828]  ? __se_sys_recvmmsg+<span class="number">0xac</span>/<span class="number">0x350</span></span><br><span class="line">[  <span class="number">106.433296</span>][ T4828]  ? __prepare_exit_to_usermode+<span class="number">0x168</span>/<span class="number">0x4d0</span></span><br><span class="line">[  <span class="number">106.440011</span>][ T4828]  __se_sys_recvmmsg+<span class="number">0x1d1</span>/<span class="number">0x350</span></span><br><span class="line">[  <span class="number">106.444414</span>][ T4828]  __x64_sys_recvmmsg+<span class="number">0x62</span>/<span class="number">0x80</span></span><br><span class="line">[  <span class="number">106.448981</span>][ T4828]  do_syscall_64+<span class="number">0xaf</span>/<span class="number">0x140</span></span><br><span class="line">[  <span class="number">106.454286</span>][ T4828]  entry_SYSCALL_64_after_hwframe+<span class="number">0x44</span>/<span class="number">0xa9</span></span><br><span class="line">[  <span class="number">106.460138</span>][ T4828] RIP: <span class="number">0033</span>:<span class="number">0x44f059</span></span><br><span class="line">[  <span class="number">106.464225</span>][ T4828] Code: Bad RIP value.</span><br><span class="line">[  <span class="number">106.468600</span>][ T4828] RSP: <span class="number">002b</span>:<span class="number">00007f</span>fe65fead18 EFLAGS: <span class="number">00000203</span> ORIG_RAX: <span class="number">000000000000012b</span></span><br><span class="line">[  <span class="number">106.477079</span>][ T4828] RAX: ffffffffffffffda RBX: <span class="number">0000000000400418</span> RCX: <span class="number">000000000044f</span>059</span><br><span class="line">[  <span class="number">106.485319</span>][ T4828] RDX: <span class="number">00000000006f</span>daec RSI: <span class="number">00000000200004</span>c0 RDI: <span class="number">0000000000000003</span></span><br><span class="line">[  <span class="number">106.492842</span>][ T4828] RBP: <span class="number">00007f</span>fe65fead30 R08: <span class="number">0000000000000000</span> R09: <span class="number">00007f</span>fe65fead30</span><br><span class="line">[  <span class="number">106.500861</span>][ T4828] R10: <span class="number">0000000000000022</span> R11: <span class="number">0000000000000203</span> R12: <span class="number">0000000000405950</span></span><br><span class="line">[  <span class="number">106.508510</span>][ T4828] R13: <span class="number">0000000000000000</span> R14: <span class="number">00000000006</span>c5018 R15: <span class="number">0000000000000000</span></span><br><span class="line">[  <span class="number">106.515322</span>][ T4828]</span><br><span class="line">[  <span class="number">106.517327</span>][ T4828] Uninit was stored to memory at:</span><br><span class="line">[  <span class="number">106.522289</span>][ T4828]  kmsan_internal_chain_origin+<span class="number">0xad</span>/<span class="number">0x130</span></span><br><span class="line">[  <span class="number">106.527916</span>][ T4828]  kmsan_memcpy_memmove_metadata+<span class="number">0x263</span>/<span class="number">0x2b0</span></span><br><span class="line">[  <span class="number">106.534956</span>][ T4828]  kmsan_memcpy_metadata+<span class="number">0xb</span>/<span class="number">0x10</span></span><br><span class="line">[  <span class="number">106.540194</span>][ T4828]  __msan_memcpy+<span class="number">0x43</span>/<span class="number">0x50</span></span><br><span class="line">[  <span class="number">106.544803</span>][ T4828]  pskb_expand_head+<span class="number">0x381</span>/<span class="number">0x1ad0</span></span><br><span class="line">[  <span class="number">106.549198</span>][ T4828]  batadv_skb_head_push+<span class="number">0x236</span>/<span class="number">0x360</span></span><br><span class="line">[  <span class="number">106.553889</span>][ T4828]  batadv_send_skb_packet+<span class="number">0x1b0</span>/<span class="number">0x8c0</span></span><br><span class="line">[  <span class="number">106.558620</span>][ T4828]  batadv_send_broadcast_skb+<span class="number">0x76</span>/<span class="number">0x90</span></span><br><span class="line">[  <span class="number">106.564056</span>][ T4828]  batadv_iv_send_outstanding_bat_ogm_packet+<span class="number">0x97e</span>/<span class="number">0xd50</span></span><br><span class="line">[  <span class="number">106.570254</span>][ T4828]  process_one_work+<span class="number">0x1552</span>/<span class="number">0x1f60</span></span><br><span class="line">[  <span class="number">106.574716</span>][ T4828]  worker_thread+<span class="number">0xf02</span>/<span class="number">0x23d0</span></span><br><span class="line">[  <span class="number">106.578995</span>][ T4828]  kthread+<span class="number">0x4f2</span>/<span class="number">0x530</span></span><br><span class="line">[  <span class="number">106.583981</span>][ T4828]  ret_from_fork+<span class="number">0x22</span>/<span class="number">0x30</span></span><br><span class="line">[  <span class="number">106.588674</span>][ T4828]</span><br><span class="line">[  <span class="number">106.591020</span>][ T4828] Uninit was created at:</span><br><span class="line">[  <span class="number">106.595629</span>][ T4828]  kmsan_save_stack_with_flags+<span class="number">0x3c</span>/<span class="number">0x90</span></span><br><span class="line">[  <span class="number">106.602610</span>][ T4828]  kmsan_alloc_page+<span class="number">0xb9</span>/<span class="number">0x180</span></span><br><span class="line">[  <span class="number">106.607341</span>][ T4828]  __alloc_pages_nodemask+<span class="number">0xc07</span>/<span class="number">0x5cf0</span></span><br><span class="line">[  <span class="number">106.612273</span>][ T4828]  page_frag_alloc+<span class="number">0x3a7</span>/<span class="number">0x900</span></span><br><span class="line">[  <span class="number">106.616519</span>][ T4828]  __netdev_alloc_skb+<span class="number">0xb22</span>/<span class="number">0xb70</span></span><br><span class="line">[  <span class="number">106.621729</span>][ T4828]  batadv_iv_ogm_queue_add+<span class="number">0x10b0</span>/<span class="number">0x18d0</span></span><br><span class="line">[  <span class="number">106.628289</span>][ T4828]  batadv_iv_ogm_schedule+<span class="number">0xd73</span>/<span class="number">0x1420</span></span><br><span class="line">[  <span class="number">106.633065</span>][ T4828]  batadv_iv_iface_enabled+<span class="number">0x37</span>/<span class="number">0x40</span></span><br><span class="line">[  <span class="number">106.637743</span>][ T4828]  batadv_hardif_enable_interface+<span class="number">0x151d</span>/<span class="number">0x1890</span></span><br><span class="line">[  <span class="number">106.643667</span>][ T4828]  batadv_softif_slave_add+<span class="number">0x198</span>/<span class="number">0x260</span></span><br><span class="line">[  <span class="number">106.648847</span>][ T4828]  do_setlink+<span class="number">0x1c1c</span>/<span class="number">0x6400</span></span><br><span class="line">[  <span class="number">106.653073</span>][ T4828]  rtnl_newlink+<span class="number">0x30fb</span>/<span class="number">0x3900</span></span><br><span class="line">[  <span class="number">106.657273</span>][ T4828]  rtnetlink_rcv_msg+<span class="number">0x119b</span>/<span class="number">0x15e0</span></span><br><span class="line">[  <span class="number">106.662538</span>][ T4828]  netlink_rcv_skb+<span class="number">0x551</span>/<span class="number">0x640</span></span><br><span class="line">[  <span class="number">106.666979</span>][ T4828]  rtnetlink_rcv+<span class="number">0x50</span>/<span class="number">0x60</span></span><br><span class="line">[  <span class="number">106.671460</span>][ T4828]  netlink_unicast+<span class="number">0xf91</span>/<span class="number">0x10f0</span></span><br><span class="line">[  <span class="number">106.676240</span>][ T4828]  netlink_sendmsg+<span class="number">0x124a</span>/<span class="number">0x14e0</span></span><br><span class="line">[  <span class="number">106.681117</span>][ T4828]  __sys_sendto+<span class="number">0xc53</span>/<span class="number">0xc80</span></span><br><span class="line">[  <span class="number">106.685521</span>][ T4828]  __se_sys_sendto+<span class="number">0x107</span>/<span class="number">0x130</span></span><br><span class="line">[  <span class="number">106.689968</span>][ T4828]  __x64_sys_sendto+<span class="number">0x6e</span>/<span class="number">0x90</span></span><br><span class="line">[  <span class="number">106.694322</span>][ T4828]  do_syscall_64+<span class="number">0xaf</span>/<span class="number">0x140</span></span><br><span class="line">[  <span class="number">106.698593</span>][ T4828]  entry_SYSCALL_64_after_hwframe+<span class="number">0x44</span>/<span class="number">0xa9</span></span><br><span class="line">[  <span class="number">106.704385</span>][ T4828]</span><br><span class="line">[  <span class="number">106.706850</span>][ T4828] Bytes <span class="number">32</span><span class="number">-33</span> of <span class="number">54</span> are uninitialized</span><br><span class="line">[  <span class="number">106.711698</span>][ T4828] Memory access of <span class="built_in">size</span> <span class="number">54</span> starts at ffffa1701f8cbc54</span><br></pre></td></tr></table></figure>

<h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><p><code>net/batman-adv/bat_iv_ogm.c#L1710</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">batadv_forw_packet</span> *<span class="title">forw_packet</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">batadv_priv</span> *<span class="title">bat_priv</span>;</span></span><br><span class="line"><span class="keyword">bool</span> dropped = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">delayed_work = to_delayed_work(work);</span><br><span class="line">forw_packet = container_of(delayed_work, struct batadv_forw_packet,</span><br><span class="line">			   delayed_work);</span><br><span class="line">bat_priv = netdev_priv(forw_packet-&gt;if_incoming-&gt;soft_iface);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (atomic_read(&amp;bat_priv-&gt;mesh_state) == BATADV_MESH_DEACTIVATING) &#123;</span><br><span class="line">	dropped = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">batadv_iv_ogm_emit(forw_packet);</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">skb = skb_clone(forw_packet-&gt;skb, GFP_ATOMIC);</span><br><span class="line">	<span class="keyword">if</span> (skb) &#123;</span><br><span class="line">		batadv_inc_counter(bat_priv, BATADV_CNT_MGMT_TX);</span><br><span class="line">		batadv_add_counter(bat_priv, BATADV_CNT_MGMT_TX_BYTES,</span><br><span class="line">				   skb-&gt;len + ETH_HLEN);</span><br><span class="line">		batadv_send_broadcast_skb(skb, hard_iface);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>应该是SKB这边有问题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(data + nhead, skb-&gt;head, skb_tail_pointer(skb) - skb-&gt;head);</span><br></pre></td></tr></table></figure>

<p>SKB是这边来的</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.8-rc5/source/drivers">drivers</a>/<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.8-rc5/source/drivers/net">net</a>/<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.8-rc5/source/drivers/net/virtio_net.c">virtio_net.c</a> line 384</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_net_hdr_mrg_rxbuf</span> *<span class="title">hdr</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> copy, hdr_len, hdr_padded_len;</span><br><span class="line"><span class="keyword">char</span> *p;</span><br><span class="line"></span><br><span class="line">p = page_address(page) + offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* copy small packet so we can reuse these pages for small data */</span></span><br><span class="line">skb = napi_alloc_skb(&amp;rq-&gt;napi, GOOD_COPY_LEN);</span><br></pre></td></tr></table></figure>



<p>看<code>skb-&gt;head</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sk_buff_data_t		tail;</span><br><span class="line">sk_buff_data_t		end;</span><br><span class="line">unsigned char		*head,</span><br><span class="line">			*data;</span><br><span class="line">unsigned int		truesize;</span><br><span class="line">refcount_t		users;</span><br></pre></td></tr></table></figure>

<p>找head是哪里来的</p>
<p>好像是send的时候出现了未初始化，然后recv的时候检测到了。。。</p>
<h1 id="KMSAN-uninit-value-in-ucma-connect"><a href="#KMSAN-uninit-value-in-ucma-connect" class="headerlink" title="KMSAN: uninit-value in ucma_connect"></a><strong>KMSAN: uninit-value in ucma_connect</strong></h1><p><code>https://syzkaller.appspot.com/bug?id=2c85ca2b1aedb22ed1029383751e36cee3f7d047</code></p>
<h2 id="Log-3"><a href="#Log-3" class="headerlink" title="Log"></a>Log</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="number">1493.720662</span>][ T8882] =====================================================</span><br><span class="line">[ <span class="number">1493.729996</span>][ T8882] BUG: KMSAN: uninit-value in ucma_connect+<span class="number">0x6ff</span>/<span class="number">0xaa0</span></span><br><span class="line">[ <span class="number">1493.736188</span>][ T8882] CPU: <span class="number">1</span> PID: <span class="number">8882</span> Comm: <span class="number">2</span>c85 Tainted: G    B             <span class="number">5.8</span><span class="number">.0</span>-rc5+ #<span class="number">6</span></span><br><span class="line">[ <span class="number">1493.744143</span>][ T8882] Hardware name: QEMU Standard PC (i440FX + PIIX, <span class="number">1996</span>), BIOS <span class="number">1.10</span><span class="number">.2</span><span class="number">-1u</span>buntu1 <span class="number">04</span>/<span class="number">01</span>/<span class="number">2014</span></span><br><span class="line">[ <span class="number">1493.754251</span>][ T8882] Call Trace:</span><br><span class="line">[ <span class="number">1493.758289</span>][ T8882]  dump_stack+<span class="number">0x1df</span>/<span class="number">0x240</span></span><br><span class="line">[ <span class="number">1493.762819</span>][ T8882]  kmsan_report+<span class="number">0xfb</span>/<span class="number">0x1e0</span></span><br><span class="line">[ <span class="number">1493.767780</span>][ T8882]  __msan_warning+<span class="number">0x58</span>/<span class="number">0xa0</span></span><br><span class="line">[ <span class="number">1493.771982</span>][ T8882]  ucma_connect+<span class="number">0x6ff</span>/<span class="number">0xaa0</span></span><br><span class="line">[ <span class="number">1493.775434</span>][ T8882]  ? kmsan_get_metadata+<span class="number">0x4f</span>/<span class="number">0x180</span></span><br><span class="line">[ <span class="number">1493.779611</span>][ T8882]  ? kmsan_internal_set_origin+<span class="number">0x85</span>/<span class="number">0xc0</span></span><br><span class="line">[ <span class="number">1493.783781</span>][ T8882]  ? kmsan_internal_unpoison_shadow+<span class="number">0x42</span>/<span class="number">0x70</span></span><br><span class="line">[ <span class="number">1493.789337</span>][ T8882]  ? _copy_from_user+<span class="number">0x15f</span>/<span class="number">0x260</span></span><br><span class="line">[ <span class="number">1493.794410</span>][ T8882]  ? kmsan_get_metadata+<span class="number">0x4f</span>/<span class="number">0x180</span></span><br><span class="line">[ <span class="number">1493.799142</span>][ T8882]  ? ucma_query_route+<span class="number">0x13b0</span>/<span class="number">0x13b0</span></span><br><span class="line">[ <span class="number">1493.804679</span>][ T8882]  ucma_write+<span class="number">0x5c5</span>/<span class="number">0x630</span></span><br><span class="line">[ <span class="number">1493.809162</span>][ T8882]  do_iter_write+<span class="number">0x703</span>/<span class="number">0xdb0</span></span><br><span class="line">[ <span class="number">1493.814716</span>][ T8882]  ? import_iovec+<span class="number">0x5f8</span>/<span class="number">0x670</span></span><br><span class="line">[ <span class="number">1493.819656</span>][ T8882]  ? ucma_get_global_nl_info+<span class="number">0xe0</span>/<span class="number">0xe0</span></span><br><span class="line">[ <span class="number">1493.824756</span>][ T8882]  do_writev+<span class="number">0x487</span>/<span class="number">0x8e0</span></span><br><span class="line">[ <span class="number">1493.828789</span>][ T8882]  ? kmsan_get_shadow_origin_ptr+<span class="number">0x81</span>/<span class="number">0xb0</span></span><br><span class="line">[ <span class="number">1493.834277</span>][ T8882]  ? __msan_metadata_ptr_for_store_4+<span class="number">0x13</span>/<span class="number">0x20</span></span><br><span class="line">[ <span class="number">1493.840115</span>][ T8882]  ? __prepare_exit_to_usermode+<span class="number">0x168</span>/<span class="number">0x4d0</span></span><br><span class="line">[ <span class="number">1493.845658</span>][ T8882]  __se_sys_writev+<span class="number">0x9b</span>/<span class="number">0xb0</span></span><br><span class="line">[ <span class="number">1493.849860</span>][ T8882]  __x64_sys_writev+<span class="number">0x4a</span>/<span class="number">0x70</span></span><br><span class="line">[ <span class="number">1493.854313</span>][ T8882]  do_syscall_64+<span class="number">0xaf</span>/<span class="number">0x140</span></span><br><span class="line">[ <span class="number">1493.860772</span>][ T8882]  entry_SYSCALL_64_after_hwframe+<span class="number">0x44</span>/<span class="number">0xa9</span></span><br><span class="line">[ <span class="number">1493.869551</span>][ T8882] RIP: <span class="number">0033</span>:<span class="number">0x44a0f9</span></span><br><span class="line">[ <span class="number">1493.874034</span>][ T8882] Code: Bad RIP value.</span><br><span class="line">[ <span class="number">1493.878046</span>][ T8882] RSP: <span class="number">002b</span>:<span class="number">00007f</span>fec53b2498 EFLAGS: <span class="number">00000217</span> ORIG_RAX: <span class="number">0000000000000014</span></span><br><span class="line">[ <span class="number">1493.887010</span>][ T8882] RAX: ffffffffffffffda RBX: <span class="number">0000000000400400</span> RCX: <span class="number">000000000044</span>a0f9</span><br><span class="line">[ <span class="number">1493.896143</span>][ T8882] RDX: <span class="number">0000000000000001</span> RSI: <span class="number">00000000200000</span>c0 RDI: <span class="number">0000000000000005</span></span><br><span class="line">[ <span class="number">1493.904654</span>][ T8882] RBP: <span class="number">00007f</span>fec53b24b0 R08: <span class="number">0000000000000000</span> R09: <span class="number">0000000000000000</span></span><br><span class="line">[ <span class="number">1493.912018</span>][ T8882] R10: <span class="number">0000000000000000</span> R11: <span class="number">0000000000000217</span> R12: <span class="number">0000000000401</span>a60</span><br><span class="line">[ <span class="number">1493.919667</span>][ T8882] R13: <span class="number">0000000000000000</span> R14: <span class="number">00000000006b</span>9018 R15: <span class="number">0000000000000000</span></span><br><span class="line">[ <span class="number">1493.927665</span>][ T8882]</span><br><span class="line">[ <span class="number">1493.929816</span>][ T8882] Local variable ----cmd@ucma_connect created at:</span><br><span class="line">[ <span class="number">1493.936290</span>][ T8882]  ucma_connect+<span class="number">0xe3</span>/<span class="number">0xaa0</span></span><br><span class="line">[ <span class="number">1493.941082</span>][ T8882]  ucma_connect+<span class="number">0xe3</span>/<span class="number">0xaa0</span></span><br><span class="line">[ <span class="number">1493.945785</span>][ T8882] =====================================================</span><br></pre></td></tr></table></figure>

<h2 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rdma_conn_param</span> <span class="title">conn_param</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rdma_ucm_ece</span> <span class="title">ece</span> = &#123;</span>&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rdma_ucm_connect</span> <span class="title">cmd</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ucma_context</span> *<span class="title">ctx</span>;</span></span><br><span class="line"><span class="keyword">size_t</span> in_size;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">in_size = <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, in_len, <span class="keyword">sizeof</span>(cmd));</span><br><span class="line"><span class="keyword">if</span> (copy_from_user(&amp;cmd, inbuf, in_size))</span><br><span class="line">	<span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>很简单的一个洞，cmd是一个栈上结构体，从用户态拷过来，但是没有限制最小长度，导致整个结构体几乎都可以未初始化</p>
<p>结构体定义是这样</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rdma_ucm_ece</span> &#123;</span></span><br><span class="line">	__u32 vendor_id;</span><br><span class="line">	__u32 attr_mod;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rdma_ucm_conn_param</span> &#123;</span></span><br><span class="line">	__u32 qp_num;</span><br><span class="line">	__u32 qkey;</span><br><span class="line">	__u8  private_data[RDMA_MAX_PRIVATE_DATA];</span><br><span class="line">	__u8  private_data_len;</span><br><span class="line">	__u8  srq;</span><br><span class="line">	__u8  responder_resources;</span><br><span class="line">	__u8  initiator_depth;</span><br><span class="line">	__u8  flow_control;</span><br><span class="line">	__u8  retry_count;</span><br><span class="line">	__u8  rnr_retry_count;</span><br><span class="line">	__u8  valid;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rdma_ucm_connect</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rdma_ucm_conn_param</span> <span class="title">conn_param</span>;</span></span><br><span class="line">	__u32 id;</span><br><span class="line">	__u32 reserved;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rdma_ucm_ece</span> <span class="title">ece</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>没有指针什么的，本来也可以从用户态拷过来完全控制，应该不可利用。。。。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://acdxvfsvd.github.io/2020/09/03/4%E4%B8%AAsyzbot-KMSAN-uninit-value-bug%E5%88%86%E6%9E%90/" data-id="ckemhzgr900004g9i4cvget4c" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2020/09/03/CVE-2017-16994%E5%88%86%E6%9E%90/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CVE-2017-16994分析</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/03/4%E4%B8%AAsyzbot-KMSAN-uninit-value-bug%E5%88%86%E6%9E%90/">4个syzbot KMSAN uninit-value bug分析</a>
          </li>
        
          <li>
            <a href="/2020/09/03/CVE-2017-16994%E5%88%86%E6%9E%90/">CVE-2017-16994分析</a>
          </li>
        
          <li>
            <a href="/2020/09/03/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 acdxvfsvd<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>